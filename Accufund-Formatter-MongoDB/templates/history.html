{% extends "base.html" %}

{% block title %}File History - Accufund Formatter{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <h2>
        <i class="fas fa-history"></i>
        File Processing History
    </h2>
    <a href="/" class="btn btn-primary">
        <i class="fas fa-upload"></i>
        Upload New File
    </a>
</div>

<!-- Summary Stats at TOP -->
<div class="stats-grid" style="margin-bottom: 30px;">
    <div class="stat-card">
        <div class="stat-info">
            <div class="stat-label">Total Files</div>
            <div class="stat-value">{{ files|length }}</div>
            <div class="stat-desc">
                <i class="fas fa-file"></i>
                All files uploaded
            </div>
        </div>
        <div class="stat-icon-wrapper">
            <i class="fas fa-folder"></i>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-info">
            <div class="stat-label">Processed</div>
            <div class="stat-value">{{ files|selectattr('status', 'equalto', 'processed')|list|length }}</div>
            <div class="stat-desc">
                <i class="fas fa-check-circle"></i>
                Successfully completed
            </div>
        </div>
        <div class="stat-icon-wrapper">
            <i class="fas fa-file-circle-check"></i>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-info">
            <div class="stat-label">Failed</div>
            <div class="stat-value">{{ files|selectattr('status', 'equalto', 'failed')|list|length }}</div>
            <div class="stat-desc">
                <i class="fas fa-times-circle"></i>
                Processing errors
            </div>
        </div>
        <div class="stat-icon-wrapper">
            <i class="fas fa-times-circle"></i>
        </div>
    </div>
</div>

<!-- History Table -->
{% if files %}
<div class="data-table-container">
    <table class="data-table">
        <thead>
            <tr>
                <th><i class="fas fa-file"></i> File Name</th>
                <th><i class="fas fa-hdd"></i> Size</th>
                <th><i class="fas fa-calendar"></i> Upload Date</th>
                <th><i class="fas fa-clock"></i> Processed Date</th>
                <th><i class="fas fa-info-circle"></i> Status</th>
                <th><i class="fas fa-download"></i> Downloads</th>
                <th><i class="fas fa-cog"></i> Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for file in files %}
            <tr>
                <td>
                    <i class="fas fa-file-excel" style="color: #38a169; margin-right: 8px;"></i>
                    <strong>{{ file.original_filename }}</strong>
                </td>
                <td>{{ (file.file_size / 1024) | round(2) }} KB</td>
                <td>{{ file.upload_date.strftime('%Y-%m-%d %H:%M') if file.upload_date else 'N/A' }}</td>
                <td>
                    {% if file.processed_date %}
                        {{ file.processed_date.strftime('%Y-%m-%d %H:%M') }}
                    {% else %}
                        <span style="color: #a0aec0;">Not processed</span>
                    {% endif %}
                </td>
                <td>
                    {% if file.status == 'processed' %}
                        <span class="status-badge status-success">
                            <i class="fas fa-check-circle"></i> Processed
                        </span>
                    {% elif file.status == 'failed' %}
                        <span class="status-badge status-failed">
                            <i class="fas fa-times-circle"></i> Failed
                        </span>
                    {% else %}
                        <span class="status-badge status-uploaded">
                            <i class="fas fa-clock"></i> Uploaded
                        </span>
                    {% endif %}
                </td>
                <td>
                    <span style="color: #413178; font-weight: 600;">{{ file.download_count }}</span>
                </td>
                <td>
                    {% if file.status == 'processed' %}
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <a href="{{ url_for('download_file', unique_id=file.unique_filename) }}" 
                               class="btn btn-success" style="padding: 8px 16px; font-size: 13px;">
                                <i class="fas fa-download"></i> Download
                            </a>
                            <a href="{{ url_for('delete_file_record', file_id=file._id) }}" 
                               class="btn btn-danger" 
                               style="padding: 8px 16px; font-size: 13px; background: #dc3545;"
                               onclick="return confirm('Are you sure you want to delete this file? This action cannot be undone.');">
                                <i class="fas fa-trash"></i> Delete
                            </a>
                        </div>
                    {% elif file.status == 'failed' %}
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <span style="color: #e53e3e; font-size: 13px;">
                                <i class="fas fa-exclamation-triangle"></i>
                                {{ file.error_message[:30] + '...' if file.error_message and file.error_message|length > 30 else file.error_message or 'Error' }}
                            </span>
                            <a href="{{ url_for('delete_file_record', file_id=file._id) }}" 
                               class="btn btn-danger" 
                               style="padding: 8px 16px; font-size: 13px; background: #dc3545;"
                               onclick="return confirm('Are you sure you want to delete this file record?');">
                                <i class="fas fa-trash"></i> Delete
                            </a>
                        </div>
                    {% else %}
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <span style="color: #a0aec0; font-size: 13px;">Pending</span>
                            <a href="{{ url_for('delete_file_record', file_id=file._id) }}" 
                               class="btn btn-danger" 
                               style="padding: 8px 16px; font-size: 13px; background: #dc3545;"
                               onclick="return confirm('Are you sure you want to delete this file record?');">
                                <i class="fas fa-trash"></i> Delete
                            </a>
                        </div>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="upload-section">
    <div class="empty-state">
        <div class="empty-icon">
            <i class="fas fa-inbox"></i>
        </div>
        <h3>No Files Yet</h3>
        <p>You haven't uploaded any files yet. Upload your first Accufund file to get started!</p>
        <a href="/" class="btn btn-primary" style="margin-top: 20px;">
            <i class="fas fa-upload"></i>
            Upload Your First File
        </a>
    </div>
</div>
{% endif %}

{% endblock %}